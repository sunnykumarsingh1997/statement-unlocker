<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paperless Gateway - PDF Unlocker</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>üìÑ Paperless Gateway</h1>
            <p class="subtitle">Unlock and upload password-protected bank statements to Paperless-ngx</p>
        </header>

        <!-- Navigation Tabs -->
        <nav class="tabs">
            <button class="tab-btn active" data-tab="upload">üì§ Upload</button>
            <button class="tab-btn" data-tab="clients">üë• Manage Clients</button>
            <button class="tab-btn" data-tab="passwords">üîë Passwords</button>
            <button class="tab-btn" data-tab="guide">üìñ User Guide</button>
        </nav>

        <main>
            <!-- Upload Tab -->
            <section id="upload-tab" class="tab-content active">
                <h2>üì§ Upload PDF Files</h2>
                <p class="section-description">Pre-select metadata (optional) or let the system auto-detect from PDF content</p>

                <!-- Metadata Form -->
                <div id="metadataForm" class="metadata-form">
                    <h3>Pre-Select Metadata (Optional)</h3>
                    <p class="form-description">Select metadata before uploading, or leave empty for auto-detection</p>

                    <div class="metadata-fields">
                        <div class="form-group">
                            <label for="clientSelect">Client</label>
                            <select id="clientSelect">
                                <option value="">-- Auto-detect --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="bankSelect">Bank</label>
                            <div class="select-with-add">
                                <select id="bankSelect">
                                    <option value="">-- Auto-detect --</option>
                                </select>
                                <button type="button" id="addBankBtn" class="btn btn-secondary btn-small">+ Add</button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Statement Type</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="statementType" value="Bank Statement">
                                    <span>Bank Statement</span>
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="statementType" value="Credit Card Statement">
                                    <span>Credit Card Statement</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Period</label>
                            <div class="period-selectors">
                                <select id="periodMonth">
                                    <option value="">-- Month --</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                                <select id="periodYear">
                                    <option value="">-- Year --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="detectedMetadata" class="detected-metadata" style="display: none;">
                        <h4>Auto-Detected Values</h4>
                        <div id="detectedValues"></div>
                        <button type="button" id="applyDetectedBtn" class="btn btn-secondary btn-small">Apply Detected</button>
                    </div>
                </div>

                <div id="dropZone" class="drop-zone">
                    <div class="drop-zone-content">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p class="drop-zone-text">Drop PDF files here or click to browse</p>
                        <p class="drop-zone-hint">Multiple files supported</p>
                    </div>
                    <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">
                </div>

                <div id="fileList" class="file-list"></div>

                <div class="upload-controls">
                    <button id="uploadBtn" class="btn btn-primary btn-large" disabled>Process & Upload Files</button>
                    <button id="clearBtn" class="btn btn-secondary" disabled>Clear Files</button>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="results-section" style="display: none;">
                    <h3>üìä Processing Results</h3>
                    <div id="resultsContainer" class="results-container"></div>
                </div>
            </section>

            <!-- Clients Tab -->
            <section id="clients-tab" class="tab-content">
                <div class="section-header">
                    <h2>üë• Manage Clients</h2>
                    <div class="header-actions">
                        <button id="syncPaperlessBtn" class="btn btn-secondary">üîÑ Sync to Paperless</button>
                        <button id="addClientBtn" class="btn btn-primary">+ Add Client</button>
                    </div>
                </div>
                <p class="section-description">Configure clients for automatic owner detection. The match pattern (account number) is searched in PDFs.</p>
                
                <div id="syncStatus" class="status-message"></div>
                
                <div id="clientsTable" class="clients-table-container">
                    <table class="clients-table">
                        <thead>
                            <tr>
                                <th>Color</th>
                                <th>Name</th>
                                <th>Match Pattern</th>
                                <th>Synced</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody">
                            <!-- Clients will be loaded here -->
                        </tbody>
                    </table>
                    <div id="noClients" class="no-clients">
                        <p>No clients configured yet. Click "Add Client" to get started.</p>
                    </div>
                </div>
            </section>

            <!-- Passwords Tab -->
            <section id="passwords-tab" class="tab-content">
                <h2>üîë Password Manager</h2>
                <p class="section-description">Manage your password list for unlocking PDFs (one password per line)</p>
                <div class="password-controls">
                    <textarea id="passwordTextarea" rows="10" placeholder="Enter passwords, one per line..."></textarea>
                    <div class="button-group">
                        <button id="loadPasswordsBtn" class="btn btn-secondary">Load Passwords</button>
                        <button id="savePasswordsBtn" class="btn btn-primary">Save Passwords</button>
                    </div>
                    <div id="passwordStatus" class="status-message"></div>
                </div>
            </section>

            <!-- User Guide Tab -->
            <section id="guide-tab" class="tab-content">
                <h2>üìñ User Guide</h2>
                <p class="section-description">Learn how to use the Paperless Gateway Middleware</p>
                
                <div class="guide-content">
                    <div class="guide-section">
                        <h3>üöÄ Getting Started</h3>
                        <p>This application helps you unlock password-protected bank statement PDFs, automatically rename them with client information and billing period, and upload them directly to your Paperless-ngx instance.</p>
                    </div>

                    <div class="guide-section">
                        <h3>üìã Step 1: Set Up Passwords</h3>
                        <ol>
                            <li>Go to the <strong>Passwords</strong> tab</li>
                            <li>Add all your bank statement passwords (one per line)</li>
                            <li>Common formats include: DOB (DDMMYYYY), PAN numbers, custom bank passwords</li>
                            <li>Click <strong>Save Passwords</strong></li>
                        </ol>
                    </div>

                    <div class="guide-section">
                        <h3>üë• Step 2: Configure Clients</h3>
                        <ol>
                            <li>Go to the <strong>Manage Clients</strong> tab</li>
                            <li>Click <strong>+ Add Client</strong></li>
                            <li>Enter the client's name (e.g., "Rahul Sharma")</li>
                            <li>Enter a <strong>Match Pattern</strong> - this is typically the account number or a unique identifier found in their statements</li>
                            <li>Choose a tag color for easy identification in Paperless</li>
                            <li>Click <strong>Save Client</strong></li>
                        </ol>
                        <div class="guide-tip">
                            <strong>üí° Tip:</strong> Open a bank statement PDF, find a unique identifier like the last 6 digits of the account number, and use that as the match pattern.
                        </div>
                    </div>

                    <div class="guide-section">
                        <h3>üîÑ Step 3: Sync to Paperless</h3>
                        <ol>
                            <li>After adding clients, click <strong>Sync to Paperless</strong></li>
                            <li>This creates tags (e.g., "Client: Rahul Sharma") in your Paperless instance</li>
                            <li>It also creates a "Bank" correspondent for all bank statements</li>
                            <li>The sync status shows whether each client's tag was created</li>
                        </ol>
                    </div>

                    <div class="guide-section">
                        <h3>üì§ Step 4: Upload PDFs</h3>
                        <ol>
                            <li>Go to the <strong>Upload</strong> tab</li>
                            <li>Drag and drop your PDF files (or click to browse)</li>
                            <li>You can upload multiple files at once</li>
                            <li>Click <strong>Process & Upload Files</strong></li>
                        </ol>
                    </div>

                    <div class="guide-section">
                        <h3>‚öôÔ∏è What Happens During Processing</h3>
                        <ol>
                            <li><strong>Unlock:</strong> Each PDF is decrypted using your password list</li>
                            <li><strong>Identify Client:</strong> The PDF text is searched for client match patterns</li>
                            <li><strong>Extract Period:</strong> The billing month/year is extracted from the statement</li>
                            <li><strong>Rename:</strong> File is renamed to <code>ClientName_YYYY-MM.pdf</code></li>
                            <li><strong>Upload:</strong> Sent to Paperless with the client's tag and "Bank" correspondent attached</li>
                        </ol>
                    </div>

                    <div class="guide-section">
                        <h3>üìÅ File Naming Format</h3>
                        <p>Files are automatically renamed using this format:</p>
                        <code class="code-block">{ClientName}_{Year}-{Month}.pdf</code>
                        <p><strong>Example:</strong> <code>Rahul_Sharma_2024-03.pdf</code></p>
                    </div>

                    <div class="guide-section">
                        <h3>‚ùì Troubleshooting</h3>
                        <div class="guide-faq">
                            <div class="faq-item">
                                <strong>PDF won't unlock?</strong>
                                <p>Make sure the correct password is in your password list. Try different formats (with/without spaces, uppercase).</p>
                            </div>
                            <div class="faq-item">
                                <strong>Wrong client detected?</strong>
                                <p>Check your match patterns. Make sure they're unique to each client. Use longer patterns if needed.</p>
                            </div>
                            <div class="faq-item">
                                <strong>Upload failed?</strong>
                                <p>Verify your Paperless-ngx instance is accessible and the API token is valid.</p>
                            </div>
                            <div class="faq-item">
                                <strong>Wrong date extracted?</strong>
                                <p>The app looks for statement dates, billing periods, or the latest date in the document. Manual renaming in Paperless may be needed for unusual formats.</p>
                            </div>
                        </div>
                    </div>

                    <div class="guide-section">
                        <h3>üîó Integration with Paperless-ngx</h3>
                        <p>This app integrates with Paperless-ngx using the following:</p>
                        <ul>
                            <li><strong>API Endpoint:</strong> <code>/api/documents/post_document/</code></li>
                            <li><strong>Tags:</strong> Created as "Client: {Name}" with your chosen color</li>
                            <li><strong>Correspondent:</strong> All uploads use "Bank" as the correspondent</li>
                            <li><strong>Workflows:</strong> Documents arrive pre-tagged, triggering your Paperless workflows immediately</li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Paperless Gateway Middleware v3.0</p>
            <p class="signature">Developed by <a href="mailto:idanielsdev@gmail.com">idanielsdev@gmail.com</a> for CodersHive</p>
            <p class="signature">For Bugs, Telegram: <a href="https://t.me/winning247365" target="_blank">@winning247365</a></p>
        </footer>
    </div>

    <!-- Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Client</h3>
                <button class="modal-close" onclick="closeClientModal()">&times;</button>
            </div>
            <form id="clientForm">
                <input type="hidden" id="clientId">
                <div class="form-group">
                    <label for="clientName">Client Name *</label>
                    <input type="text" id="clientName" placeholder="e.g., Rahul Sharma" required>
                </div>
                <div class="form-group">
                    <label for="matchPattern">Match Pattern (Account Number) *</label>
                    <input type="text" id="matchPattern" placeholder="e.g., 1234567890" required>
                    <small>This pattern will be searched in PDF content to identify the client</small>
                </div>
                <div class="form-group">
                    <label for="clientColor">Tag Color</label>
                    <div class="color-input-group">
                        <input type="color" id="clientColor" value="#3b82f6">
                        <input type="text" id="clientColorText" value="#3b82f6" pattern="^#[0-9A-Fa-f]{6}$">
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeClientModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bank Modal -->
    <div id="bankModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="bankModalTitle">Add Bank</h3>
                <button class="modal-close" onclick="closeBankModal()">&times;</button>
            </div>
            <form id="bankForm">
                <input type="hidden" id="bankId">
                <div class="form-group">
                    <label for="bankNameInput">Bank Name *</label>
                    <input type="text" id="bankNameInput" placeholder="e.g., HDFC Bank" required>
                </div>
                <div class="form-group">
                    <label for="bankPatterns">Detection Patterns (comma-separated)</label>
                    <input type="text" id="bankPatterns" placeholder="e.g., HDFC, HDFC Bank">
                    <small>Patterns to detect this bank in PDF text</small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeBankModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Bank</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Password Input Modal (for manual password entry on timeout) -->
    <div id="passwordModal" class="modal">
        <div class="modal-content password-modal">
            <div class="modal-header warning">
                <h3>Password Required</h3>
                <button class="modal-close" onclick="closePasswordModal()">&times;</button>
            </div>
            <div class="password-modal-body">
                <div class="password-file-info">
                    <p class="file-name">File: <strong id="passwordFileName">-</strong></p>
                    <p class="timeout-message">Could not unlock with saved passwords. Please enter the password manually.</p>
                </div>
                <form id="passwordForm">
                    <div class="form-group">
                        <label for="manualPassword">PDF Password *</label>
                        <input type="text" id="manualPassword" placeholder="Enter password" required autocomplete="off">
                        <small>Common formats: DOB (DDMMYYYY), PAN number, account number</small>
                    </div>
                    <div class="form-group checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="savePassword" checked>
                            <span>Save this password for future use</span>
                        </label>
                    </div>
                    <div id="passwordError" class="error-message" style="display: none;"></div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="skipPasswordFile()">Skip This File</button>
                        <button type="submit" class="btn btn-primary">Try Password</button>
                    </div>
                </form>
            </div>
            <div class="password-progress" id="passwordProgress" style="display: none;">
                <div class="progress-spinner"></div>
                <p>Trying password...</p>
            </div>
        </div>
    </div>

    <script src="/static/app.js"></script>
</body>
</html>
